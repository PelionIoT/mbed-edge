/*
 * Debug test for ssl_platform_pk_sign with mbedTLS backend
 */

#include "ssl_platform.h"
#include <stdio.h>
#include <string.h>

// Test private key in DER format (secp256r1)
static const unsigned char test_key_der[] = {
    0x30, 0x77, 0x02, 0x01, 0x01, 0x04, 0x20,
    0x60, 0x75, 0x15, 0x9d, 0x87, 0x4b, 0x7e, 0x8e, 0x6c, 0x3e, 0x6a, 0x2b, 0x7c, 0x8d, 0x9f, 0xa0,
    0x5b, 0x2c, 0x98, 0x6d, 0x7e, 0x8f, 0xa0, 0x6c, 0x3e, 0x6a, 0x2b, 0x7c, 0x8d, 0x9f, 0xa0, 0x5b,
    0xa0, 0x0a, 0x06, 0x08, 0x2a, 0x86, 0x48, 0xce, 0x3d, 0x03, 0x01, 0x07, 0xa1, 0x44, 0x03, 0x42,
    0x00, 0x04, 0x4f, 0x2a, 0x4e, 0x8e, 0x6c, 0x3e, 0x6a, 0x2b, 0x7c, 0x8d, 0x9f, 0xa0, 0x5b, 0x2c,
    0x98, 0x6d, 0x7e, 0x8f, 0xa0, 0x6c, 0x3e, 0x6a, 0x2b, 0x7c, 0x8d, 0x9f, 0xa0, 0x5b, 0x2c, 0x98,
    0x6d, 0x7e, 0x8f, 0xa0, 0x6c, 0x3e, 0x6a, 0x2b, 0x7c, 0x8d, 0x9f, 0xa0, 0x5b, 0x2c, 0x98, 0x6d,
    0x7e, 0x8f, 0xa0, 0x6c, 0x3e, 0x6a, 0x2b, 0x7c, 0x8d, 0x9f, 0xa0, 0x5b, 0x2c, 0x98, 0x6d, 0x7e
};

int main(void)
{
    printf("Testing ssl_platform_pk_sign with mbedTLS backend\n");
    
    ssl_platform_pk_context_t pk_ctx;
    ssl_platform_pk_init(&pk_ctx);
    
    // Parse the test key
    int ret = ssl_platform_pk_parse_key(&pk_ctx, test_key_der, sizeof(test_key_der), NULL, 0);
    printf("ssl_platform_pk_parse_key returned: %d\n", ret);
    
    if (ret != SSL_PLATFORM_SUCCESS) {
        printf("Failed to parse private key\n");
        ssl_platform_pk_free(&pk_ctx);
        return 1;
    }
    
    // Test hash to sign
    unsigned char hash[32] = {
        0x34, 0x70, 0xCD, 0x54, 0x7B, 0x0A, 0x11, 0x5F, 0xE0, 0x5C, 0xEB, 0xBC, 0x07, 0xBA, 0x91, 0x88,
        0x27, 0x20, 0x25, 0x6B, 0xB2, 0x7A, 0x66, 0x89, 0x1A, 0x4B, 0xB7, 0x17, 0x11, 0x04, 0x86, 0x6F
    };
    
    unsigned char signature[256];
    size_t sig_len = sizeof(signature);
    
    // Test backend context access
    void *backend_ctx = ssl_platform_pk_get_backend_context(&pk_ctx);
    printf("Backend context: %p\n", backend_ctx);
    
    // Try to sign
    printf("Attempting to sign...\n");
    ret = ssl_platform_pk_sign(&pk_ctx, SSL_PLATFORM_HASH_SHA256, hash, sizeof(hash), 
                               signature, &sig_len, NULL, NULL);
    
    printf("ssl_platform_pk_sign returned: %d\n", ret);
    if (ret == SSL_PLATFORM_SUCCESS) {
        printf("Signature length: %zu\n", sig_len);
        printf("Signature created successfully!\n");
    } else {
        printf("Signing failed with error: %d\n", ret);
    }
    
    ssl_platform_pk_free(&pk_ctx);
    return (ret == SSL_PLATFORM_SUCCESS) ? 0 : 1;
} 